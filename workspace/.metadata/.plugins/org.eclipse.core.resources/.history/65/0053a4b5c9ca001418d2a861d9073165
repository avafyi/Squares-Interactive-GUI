import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.Point;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;

import javax.imageio.ImageIO;
import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.SwingUtilities;

// Swing Program Template
@SuppressWarnings("serial")
public class SquintMainWindow extends JPanel implements KeyListener {

	public static final String TITLE = "...Squares Interactive GUI...";

	// Name-constants (DIM stands for Dimension)
	public static final int ROOM_DIM = 400;				// The pixel width and height of the room
	public static final int CANVAS_WIDTH = 520;	// the pixel width of the room
	public static final int CANVAS_HEIGHT = 560;		// the pixel height of the room
	public static final int LEFT_WALL_OFFSET = 80;
	public static final int TOP_WALL_OFFSET = 120;
	public static final int TILES_DIM = 10;						// the number of tiles (squares) in a row or column
	public static final int TILE_DIM = ROOM_DIM / TILES_DIM;	// the number of pixels per tile
	public static final int CANVAS_DIM = 40;					// the number of pixels per grid square
	public static final int NUM_SQUARES_ACROSS = CANVAS_WIDTH / CANVAS_DIM;
	public static final int NUM_SQUARES_DOWN = CANVAS_HEIGHT / CANVAS_DIM;
	
	public Player player = null;

	// ......

	// private variables of GUI components
	// ......

	/** Constructor to setup the GUI components */
	public SquintMainWindow() {
		player = new Player(0,0,Player.DOWN, true);		
		
		setPreferredSize(new Dimension(CANVAS_WIDTH, CANVAS_HEIGHT));
		
		addKeyListener(this);
        setFocusable(true);
        setFocusTraversalKeysEnabled(false);
		
		// "this" JPanel container sets layout
		// setLayout(new ....Layout());

		// Allocate the UI components
		// .....

		// "this" JPanel adds components
		// add(....)

		// Source object adds listener
		// .....
	}

	/** Custom painting codes on this JPanel */
	@Override
	public void paintComponent(Graphics g) {
		super.paintComponent(g);  // paint background
		setBackground(Color.WHITE);
		Graphics2D g2d = (Graphics2D) g;
		
		drawGrid(g);	// Draw the room grid
		drawPlayer(player.x, player.y, g2d);	// Draw the player
		// Draw the player
		// Your custom painting codes
		// ......
	}

	/**
	 * Draws the gridlines to define tiles in the room
	 * 
	 * @param numTilesPerRowAndCol		the number of tiles per row and per column
	 * @param g							the graphics object
	 */
	private void drawGrid(Graphics g) {	      
		int stepWidth = TILE_DIM;
		int stepHeight = TILE_DIM;
		
//		for (int i = 0; i <= TILES_DIM; i++) {
//			g.drawLine(stepWidth * i, 0, stepWidth*i, CANVAS_HEIGHT);
//			g.drawLine(0, stepHeight * i, CANVAS_WIDTH, stepHeight * i);
//		}

		
		// Save the pixel coordinates of the top left of each tile
//		Point[][] tileCoords = new Point[TILES_DIM][TILES_DIM]; 	
//		for (int row = 0; row < TILES_DIM; row++) {
//			for (int col = 0; col < TILES_DIM; col++) {	
//				tileCoords[row][col] = new Point(LEFT_WALL_OFFSET + col * stepWidth, TOP_WALL_OFFSET + row * stepHeight);				
//			}
//		}
		Point[][] roomCoords = new Point[NUM_SQUARES_DOWN][NUM_SQUARES_ACROSS]; 	
		for (int row = 0; row < NUM_SQUARES_DOWN; row++) {
			for (int col = 0; col < NUM_SQUARES_ACROSS; col++) {	
				roomCoords[row][col] = new Point(col * CANVAS_DIM, row * CANVAS_DIM);				
			}
		}
		
		String[][][] room = new String[][][] {
			{
				{"in_walls/0.png", "", "in_walls/3.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/1.png", "in_walls/4.png", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/13.png"},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "", ""},
				{"in_walls/12.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "", ""},
			},
			{
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/0.png", "in_shadows/1.png", "in_shadows/1.png", "in_shadows/1.png", "in_shadows/1.png", "in_shadows/1.png", "in_shadows/1.png", "in_shadows/1.png", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/6.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"in_walls/14.png", "", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_floor/5.png", "in_walls/15.png", "", "", "", "", ""},
				{"", "", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "in_walls/17.png", "", ""},
			},
			{
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "in_shadows/8.png", "", "", "", "", "", "", "", "", "", "", "", ""},
				{"", "", "", "", "", "", "", "", "", "", "", "", "", ""},
			}
		};
		
		for (int layer = 0; layer < room.length; layer++) {
			for (int row = 0; row < NUM_SQUARES_DOWN; row++) {
				for (int col = 0; col < NUM_SQUARES_ACROSS; col++) {
					// Allow for empty grid spots in case of larger images
					if ( room[layer][row][col] != "" ) {
						// If the image to be drawn to the grid is for shading we want to handle it differently
						if (room[layer][row][col].contains("shad")) {
							drawImageToGrid(room[layer][row][col], roomCoords[row][col].x, roomCoords[row][col].y, g, true);							
						} else {
							drawImageToGrid(room[layer][row][col], roomCoords[row][col].x, roomCoords[row][col].y, g, false);
						}
					}
				}
			}	
		}
	}
	
	private void drawImageToGrid(String fileURL, int x_coord, int y_coord, Graphics g, boolean isShading) {
		File imageSrc = new File("res/images/" + fileURL);		
		Image img = null;
		try {
			img = ImageIO.read(imageSrc);
		} catch (IOException e) {
			e.printStackTrace();
			System.out.println("Failed to read image file");
		}
		if (img == null) {
			return;
		}
		if (isShading) {
			// Go through each shade level, represented by a unique color, and
			// replace the color with a transparent black
			Color shadeLevelOneColor = new Color(0x000000);
			Color shadeLevelTwoColor = new Color(0x7F007F);
			Color shadeLevelThreeColor = new Color(0xff00ff);
			img = Transparency.makeColorTransparent(img, shadeLevelOneColor, 80);
			img = Transparency.makeColorTransparent(img, shadeLevelTwoColor, 40);
			img = Transparency.makeColorTransparent(img, shadeLevelThreeColor, 20);
		}
		Graphics2D g2d = (Graphics2D) g;
		g2d.drawImage(img, x_coord, y_coord, null);
	}
	
//	private int translateCoords(int x, int y) {
//		return (int)(y * TILES_DIM) + x;
//	}

	private void drawPlayer(int tile_x, int tile_y, Graphics g) {	
		double player_height = TILE_DIM * 0.8;
		double player_width = player_height;
		double eye_height = player_height / 4;
		double eye_width = eye_height;

		int player_x = tile_x * TILE_DIM;
		int player_y = tile_y * TILE_DIM;	

		double player_x_offset = (TILE_DIM - player_width) / 2;
		double player_y_offset = (TILE_DIM - player_height) / 2;
		double eye_left_x_offset = player_x_offset + eye_width * 0.8;  
		double eye_y_offset = player_y_offset + eye_height * 1.0;
		double eye_right_x_offset = player_width - (eye_left_x_offset - player_x_offset) - eye_width/2; //player_x + (TILE_DIM - (eye_left_x_offset - player_x) - player_eye_width);  

		// Translate so we are drawing only within the relevant tile
		g.translate(player_x, player_y);
	    Graphics2D gg = (Graphics2D) g.create();
	    gg.rotate(Math.toRadians(90 * player.direction), TILE_DIM/2, TILE_DIM/2);

	    
		gg.setColor(player.PLAYER_COLOR);
		gg.fillArc((int)player_x_offset, (int)player_y_offset, (int)player_height, (int)player_width, 0, 360);
		gg.setColor(Color.BLACK);

		// Outline the player
		gg.drawArc((int)player_x_offset, (int)player_y_offset, (int)player_height, (int)player_width, 0, 360);   

		// Draw the smile
		gg.drawArc((int)player_x_offset, (int)(TILE_DIM - eye_y_offset - player_height), (int)player_height, (int)player_width, 235, 70);

		// Draw the eyes
		gg.fillArc((int)eye_left_x_offset, (int)eye_y_offset, (int)eye_height, (int)eye_width, 0, 360);
		gg.fillArc((int)eye_right_x_offset, (int)eye_y_offset, (int)eye_height, (int)eye_width, 0, 360);
	    gg.dispose();
	    
	    gg = (Graphics2D) g.create();
	}
	
	private void moveRight() {
		if ( player.direction != player.RIGHT ) {
			player.direction = player.RIGHT;
		} else if ( player.x < TILES_DIM - 1 ) {
			player.x++;		
	        player.startMoveTimer();	
		}
	}
	
	private void moveUp() {
		if ( player.direction != player.UP ) {
			player.direction = player.UP;
		} else if ( player.y > 0 ) {
			player.y--;
	        player.startMoveTimer();
		}		
	}
	
	private void moveLeft() {
		if ( player.direction != player.LEFT ) {
			player.direction = player.LEFT;
		} else if ( player.x > 0 ) {
			player.x--;
	        player.startMoveTimer();
		}		
	}
	
	private void moveDown() {
		if ( player.direction != player.DOWN ) {
			player.direction = player.DOWN;
		} else if ( player.y < TILES_DIM - 1 ) {
			player.y++;
	        player.startMoveTimer();
		}				
	}


	/** The entry main() method */
	public static void main(String[] args) {
		// Run GUI codes in the Event-Dispatching thread for thread safety
		SwingUtilities.invokeLater(new Runnable() {
			public void run() {
				JFrame frame = new JFrame(TITLE);
				frame.setContentPane(new SquintMainWindow());
				frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
				frame.setResizable(false);
				frame.pack();             // "this" JFrame packs its components
				frame.setLocationRelativeTo(null); // center the application window
				frame.setVisible(true);            // show it
			}
		});
	}

	@Override
	public void keyPressed(KeyEvent e) {
		if (player.allowedToMove) {
	        if(e.getKeyCode()== KeyEvent.VK_D || e.getKeyCode()== KeyEvent.VK_RIGHT) {
	        	moveRight();
	        } else if(e.getKeyCode()== KeyEvent.VK_W || e.getKeyCode()== KeyEvent.VK_UP) {
	        	moveUp();
	        } else if(e.getKeyCode()== KeyEvent.VK_A || e.getKeyCode()== KeyEvent.VK_LEFT) {
	        	moveLeft();
	        } else if(e.getKeyCode()== KeyEvent.VK_S || e.getKeyCode()== KeyEvent.VK_DOWN) {
	        	moveDown();
	        }
	        repaint();
		}
        System.out.println("keyPressed");
	}

	@Override
	public void keyReleased(KeyEvent e) {
        System.out.println("keyReleased");
	}

	@Override
	public void keyTyped(KeyEvent e) {
        System.out.println("keyTyped");
	}
}
